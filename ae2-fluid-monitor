-- Format bytes to human-readable
local function formatBytes(bytes)
    if bytes >= 1000000000 then
        return string.format("%.1fM", bytes / 1000000000)
    elseif bytes >= 1000000 then
        return string.format("%.1fK", bytes / 1000000)
    else
        return string.format("%.1f", bytes / 1000)
    end
end

-- Strip mod ID from chemical name
local function formatChemicalName(name)
    return name:match(".+:(.+)") or name
end

-- Center text on monitor
local function centerText(monitor, text, line)
    local w, _ = monitor.getSize()
    local x = math.floor((w - #text) / 2) + 1
    monitor.setCursorPos(x, line)
    monitor.write(text)
end

-- Get internal chemicals from AE2
local function getInternalChemicals(bridge)
    if bridge.listChemicals then
        local chemicals = bridge.listChemicals() or {}
        -- Optional: AE2 Bytes â†’ Millibuckets
        for _, c in ipairs(chemicals) do
            if c.amount then
                c.amount = math.floor(c.amount / 1000)
            end
        end
        return chemicals
    end
    return {}
end

-- Main display loop
local function updateDisplay()
    local monitor = peripheral.find("monitor")
    local bridge = peripheral.find("me_bridge")
    if not monitor then
        print("No monitor found.")
        return
    end
    if not bridge then
        print("No ME Bridge found.")
        return
    end

    monitor.setTextScale(1)
    monitor.clear()

    while true do
        monitor.clear()

        local internalChemicals = getInternalChemicals(bridge)

        -- Sort internal chemicals by amount descending
        table.sort(internalChemicals, function(a,b) return (a.amount or 0) > (b.amount or 0) end)

        -- Display internal chemicals starting at line 1
        local line = 1
        for _, c in ipairs(internalChemicals) do
            centerText(monitor, string.format("%s: %s B", formatChemicalName(c.name), formatBytes(c.amount or 0)), line)
            line = line + 1
        end

        sleep(5)
    end
end

updateDisplay()
